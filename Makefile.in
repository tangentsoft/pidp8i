CFLAGS=-std=c99 -Wno-unused-result \
	-D_GNU_SOURCE -DUSE_READER_THREAD -DHAVE_DLOPEN=so -DPIDP8 -U__STRICT_ANSI__ \
	-I src -I src/PDP8

SIM = bin/pidp8i-sim
BINS = $(SIM) bin/scanswitch

BUILDDIRS = bin obj/PDP8

INSTDIRS = bootscripts bin etc imagefiles

OBJS = \
	obj/gpio.o \
	obj/PDP8/pdp8_cpu.o \
	obj/PDP8/pdp8_clk.o \
	obj/PDP8/pdp8_ct.o \
	obj/PDP8/pdp8_df.o \
	obj/PDP8/pdp8_dt.o \
	obj/PDP8/pdp8_fpp.o \
	obj/PDP8/pdp8_lp.o \
	obj/PDP8/pdp8_mt.o \
	obj/PDP8/pdp8_pt.o \
	obj/PDP8/pdp8_rf.o \
	obj/PDP8/pdp8_rk.o \
	obj/PDP8/pdp8_rl.o \
	obj/PDP8/pdp8_rx.o \
	obj/PDP8/pdp8_sys.o \
	obj/PDP8/pdp8_td.o \
	obj/PDP8/pdp8_tsc.o \
	obj/PDP8/pdp8_tt.o \
	obj/PDP8/pdp8_ttx.o \
	obj/scp.o \
	obj/sim_console.o \
	obj/sim_disk.o \
	obj/sim_ether.o \
	obj/sim_fio.o \
	obj/sim_serial.o \
	obj/sim_sock.o \
	obj/sim_tape.o \
	obj/sim_timer.o \
	obj/sim_tmxr.o

LIBS = -lm -ldl -lpthread

CLTXT = /boot/cmdline.txt


all: $(BUILDDIRS) $(BINS)

clean:
	@rm -f $(BINS) $(OBJS) $(OBJS:.o=.d)
	-rmdir -p $(BUILDDIRS) 2> /dev/null || true

distclean: clean
	@rm -f config.log Makefile autosetup/jimsh0 src/config.h

install:
	@echo Installing to @prefix@...

	@# Create any missing install tree directories
	for d in $(INSTDIRS) ; do @INSTALL@ -m 755 -d @prefix@/$$d ; done

	@# Install files into those dirs and set their perms
	@INSTALL@ -m 755 -s $(BINS) @prefix@/bin
	@INSTALL@ -m 755 @srcdir@/bin/pidp8i @prefix@/bin
	-setcap 'cap_sys_nice=eip' @prefix@/$(SIM) || true
	find ./imagefiles \( \
		-name \*.bin  -o \
		-name \*.dsk  -o \
		-name \*.rk05 -o \
		-name \*.tu56 \) \
		-exec @INSTALL@ -D -m 640 {} @prefix@/{} \;
	@INSTALL@ -m 640 @srcdir@/bootscripts/*.script @prefix@/bootscripts

	@# If this is a Debian-type system, install needed helper programs
	@test -x /usr/bin/apt-get && ( \
		test ! -f /etc/usbmount/usbmount.conf && apt-get install usbmount \
		test ! -x /usr/bin/screen && apt-get install screen \
	) || true

	@# Install the init script if this system is SysVinit based.
	@# Raspbian's systemd setup is close enough.
	@INSTALL@ -m 750 @srcdir@/etc/pidp8i-init @prefix@/etc
	@(  test -w /etc/init.d && \
		ln -sf @ABSPREFIX@/etc/pidp8i-init /etc/init.d/pidp8i && \
		update-rc.d pidp8i defaults \
	) || true

	@# Add installation bin dir to the non-root user's PATH unless it's
	@# already in there or we aren't running under sudo.
	@(for p in .profile .bash_profile ; do \
		test -n "$$SUDO_USER" -a -w "/home/$$SUDO_USER/$$p" && \
			! grep -qF "@ABSPREFIX@" "/home/$$SUDO_USER/$$p" && \
			echo "export PATH=\$$PATH:@ABSPREFIX@/bin" >> "/home/$$SUDO_USER/$$p" ; \
	done) || true

	@# If serial mod is enabled, turn off serial console and kgdb stuff
	@# in case they were enabled previously, else they will fight with
	@# our use of GPIO.
	@(  test -z "@SERIALSETUP@" -a -r $CLTXT && ! -w $CLTXT && \
		cp -p $CLTXT "$CLTXT"_orig && \
		sed -e 's/console\=[a-zA-Z0-9]+,[0-9]+ //' \
		    -e  's/kgdboc\=[a-zA-Z0-9]+,[0-9]+ //' -i $CLTXT \
	) || true

reconfig:
	@AUTOREMAKE@


# Rule for compiling *.c to *.o and autogenerating dependency info.
# Explained at http://scottmcpeak.com/autodepend/autodepend.html
obj/%.o: src/%.c
	$(CC) -c $(CFLAGS) src/$*.c -o obj/$*.o
	$(CC) -MM $(CFLAGS) src/$*.c > obj/$*.d
	@mv -f obj/$*.d obj/$*.d.tmp
	@sed -e 's|.*:|obj/$*.o:|' < obj/$*.d.tmp > obj/$*.d
	@sed -e 's/.*://' -e 's/\\$$//' < obj/$*.d.tmp | fmt -1 | \
		sed -e 's/^ *//' -e 's/$$/:/' >> obj/$*.d
	@rm -f obj/$*.d.tmp


$(BUILDDIRS):
	mkdir -p $@

$(SIM): $(OBJS)
	$(CC) $(CFLAGS) -o $@ $^ $(LIBS)

bin/scanswitch: src/scanswitch/scanswitch.c src/scanswitch/gpio.h
	$(CC) -Isrc/scanswitch -o $@ $<

ifeq ($(findstring clean,$(MAKECMDGOALS)),)
Makefile: @AUTODEPS@ @srcdir@/Makefile.in
	@@AUTOREMAKE@
endif

-include $(OBJS:.o=.d)
