########################################################################
# auto.def - Configure file for the PiDP-8/I software build system,
#            based on autosetup.
########################################################################

define defaultprefix /opt/pidp8

use cc

options {
	serial-mod => "build simulator to expect the PCB serial mods"
}

if {[opt-bool serial-mod]} {
	msg-result "The simulator will expect the serial mods to the Pi and PiDP-8/I PCBs."
	define SERIALSETUP
}

cc-check-includes time.h
cc-check-functions clock_nanosleep nanosleep usleep

# We need to find an install(1) type program that supports -D.  The
# Raspberry Pi OSes typically used with the PiDB-8/I board do have this,
# but this package also runs on non-Linux OSes (e.g. for testing on a
# desktop Mac) so make sure we've got a suitable implementation.  The
# ginstall name is typical on non-Linux systems where GNU Coreutils was
# installed alongside the core OS utilities.
if {[cc-check-progs ginstall]} {
	define INSTALL ginstall		# assume it's GNU install(1)
} elseif {[cc-check-progs install]} {
	if {[catch {exec install -D -d . >& /dev/null} result] == 0} {
		define INSTALL install
	} else {
		user-error "install(1) does not support -D; install GNU Coreutils."
	}
} else {
	user-error "No install(1) type program found; install GNU Coreutils."
}

# Also find GNU readlink in the same way
if {[cc-check-progs greadlink]} {
	set rlprg greadlink
} elseif {[cc-check-progs readlink]} {
	if {[catch {exec readlink -f . >& /dev/null} result] == 0} {
		set rlprg readlink
	} else {
		user-error "readlink(1) does not support -D; install GNU Coreutils."
	}
} else {
	user-error "No readlink(1) type program found; install GNU Coreutils."
}

# Absolutize the prefix, for generated scripts
define ABSPREFIX [exec $rlprg -f [get-define prefix]]

make-config-header src/config.h \
	-auto {ENABLE_* HAVE_* PACKAGE_* SIZEOF_*} \
	-bare {SERIALSETUP}
make-template Makefile.in
make-template bootscripts/0.script.in
make-template bootscripts/2.script.in
make-template bootscripts/3.script.in
make-template bootscripts/4.script.in
make-template bootscripts/6.script.in
make-template bootscripts/7.script.in
